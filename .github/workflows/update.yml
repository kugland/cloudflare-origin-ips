# This GitHub Workflow should be executed once a week to update the
# list of Cloudflare origin IPs.

# This will download the latest list of Cloudflare IPs, and if there
# are any changes, it will commit them to the repository.

name: Update Cloudflare IPs

on:
  schedule:
    - cron: "0 0 * * 0"
  push:
    branches:
      - "master"

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      # Setup a GPG key for signing the commit
      - uses: crazy-max/ghaction-import-gpg@v3
        with:
          gpg-private-key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.GPG_PASSPHRASE }}
          git-user-signingkey: true
          git-commit-gpgsign: true
      - name: Update Cloudflare IPs
        run: |
          curl -s https://www.cloudflare.com/ips-v4 > ips-v4.txt
          curl -s https://www.cloudflare.com/ips-v6 > ips-v6.txt
      - name: Commit changes
        run: |
          # Test if there are any changes
          git diff --quiet --exit-code ips-v4.txt ips-v6.txt && exit 0
          git add ips-v4.txt ips-v6.txt
          git commit -S -m "Update Cloudflare origin IPs" || true
      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GH_TOKEN }}
          branch: master
